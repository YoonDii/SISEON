{% extends 'base.html' %}
{% load django_bootstrap5%}
{% load static %}

{% block content %}
조회수:{{ articles.hits }}
  {% if articles.unname %}
    익명{{articles.user.pk}}
  {{articles.title}}
  {{articles.category}}
  {{articles.updated_at}}
  {{articles.content}}

  {% else %}
  
  <a href={% url 'accounts:detail' articles.user.pk %}>{{articles.user.nickname}}</a>
  {{articles.title}}
  {{articles.category}}
  {{articles.updated_at}}
  {{articles.content}}
  
  {% endif %}

  {% if photos %}
    {% for photo in photos %}
      <img src="{{ photo.image.url }}">
    {% endfor %}
  {% endif %}
  <!-- 수정 / 삭제 -->
  {% if request.user == articles.user %}
    <div class="d-flex justify-content-end">
      <a href="{% url 'articles:update' articles.pk %}" class="btn btn-primary">수정</a>
      <form class="m-0" action="{% url 'articles:delete' articles.pk %}" method="POST">
        {% csrf_token %}
        <input type="submit" value="삭제">
      </form>
    </div>
    <!-- 좋아요 -->
  {% else %}
    <div class="d-flex justify-content-end">
      <form class='like-form m-0 d-flex align-items-center' data-articles-pk='{{ articles.pk }}'>
        {% csrf_token %}
        {% if request.user in articles.like_users.all %}
          <button class="btn btn-link text-danger">
            <i class="bi bi-heart-fill heart-icon"></i>
          </button>
        {% else %}
          <button class="btn btn-link text-danger">
            <i class="bi bi-heart heart-icon"></i>
          </button>
        {% endif %}
        <span class='like-cnt'>{{articles.like_users.count}}</span>
      </form>
    </div>
  {% endif %}
  <!-- 댓글 -->
  <section class="comment-box">
    {% if request.user.is_authenticated %}
      <form id="comment-form" data-articles-id="{{ articles.pk }}" action="{% url 'articles:comment_create' articles.pk %}" method="POST">
        {% csrf_token %}
        {% bootstrap_form comment_form %}
        <input class="btn btn-success" type="submit" value="제출">
      </form>
    {% endif %}
    <div id="comments">
      {% for comment in comments %}
        <div class="comment">
          {% if not comment.unname %}
          <h4>{{comment.user}} - {{ comment.content }}</h4>
          {% else %}
          <h4>익명{{comment.user.pk}} - {{ comment.content }}</h4>
          {% endif %}
          <div>
            {% if request.user.pk == comment.user.pk %}
              <div>
                <div id="form-comment-update-{{ comment.pk }}" style="display:none;">
                  <input id="input-{{ comment.pk }}" type="text" value="{{ comment.content }}">
                  <button onclick="ok_function(this)" id="okBtn-{{ comment.pk }}" data-articlesup-id="{{ articles.pk }}" data-commentup-id="{{ comment.pk }}">확인</button>
                </div>
                <button  onclick="update_comment(this)" id="comment-update-{{ comment.pk }}" data-articlesup-id="{{ articles.pk }}" data-commentup-id="{{ comment.pk }}">수정</button>
                <button  onclick="delete_comment(this)" id="comment-delete-{{ comment.pk }}" data-articlesdel-id="{{ articles.pk }}" data-commentdel-id="{{ comment.pk }}">삭제</button>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </section>
{% endblock %}
{% block js %}

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  //댓글 생성 비동기
  const commentForm = document.querySelector('#comment-form')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

      commentForm.addEventListener('submit', function (event) {
        event.preventDefault();
        axios({
          method: 'post',
          url: `/articles/${event.target.dataset.articlesId}/comment_create/`,
          headers: {
            'X-CSRFToken': csrftoken
          },
          data: new FormData(commentForm)
        })
          .then(response => {
            console.log(response)
            const comments = document.querySelector('#comments')
            comments.textContent = "";
            const hr = document.createElement('hr')
            const comment_data = response.data.comment_data
            const user = response.data.user
              for (let i = 0; i < comment_data.length; i++) {
                const articles_pk = response.data.articles_pk
                  console.log(comment_data[i].id, user, comment_data[i].unname)
                if (user === comment_data[i].id) {
                  comments.insertAdjacentHTML('beforeend', `
                  <div class="comment">
                    <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
                    <div>
                      <div>
                        <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
                          <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
                          <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-articlesup-id="${ articles_pk }" data-commentup-id="${comment_data[i].commentPk}">확인</button>
                        </div>
                        <button  onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-articlesup-id="${ articles_pk }" data-commentup-id="${comment_data[i].commentPk}">수정</button>\
                        <button  onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-articlesdel-id="${ articles_pk }" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                      </div>
                    </div>
                  </div>
                  `);
                } else {
                  comments.insertAdjacentHTML('beforeend', `
                    <div class="comment">
                      <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
                    </div>
                  `);
                }
              }
              commentForm
              .reset()
          }
          )
          .catch(console.log(1))
        })
</script>
<script>
  // 댓글 삭제 비동기
  const delete_comment = (e) => {
    const comment_id = document
      .querySelector(`#${e.id}`)
      .id;
    axios({
      method: 'post',
      url: `/articles/${event.target.dataset.articlesdelId}/comment_delete/${event.target.dataset.commentdelId}/delete/`,
      headers: {
        'X-CSRFToken': csrftoken
      }
    }).then(response => {
      console.log(response)
      const comments = document.querySelector('#comments')
      comments.textContent = "";
      const hr = document.createElement('hr')
      const comment_data = response.data.comment_data
      const user = response.data.user
        for (let i = 0; i < comment_data.length; i++) {
          const articles_pk = response.data.articles_pk
            console.log(comment_data[i].id, user, comment_data[i].unname)
          if (user === comment_data[i].id) {
            comments.insertAdjacentHTML('beforeend', `
            <div class="comment">
              <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
              <div>
                <div>
                  <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
                    <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
                    <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-articlesup-id="${ articles_pk }" data-commentup-id="${comment_data[i].commentPk}">확인</button>
                  </div>
                  <button  onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-articlesup-id="${ articles_pk }" data-commentup-id="${comment_data[i].commentPk}">수정</button>\
                  <button  onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-articlesdel-id="${ articles_pk }" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                </div>
              </div>
            </div>
            `);
          } else {
            comments.insertAdjacentHTML('beforeend', `
              <div class="comment">
                <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
              </div>
            `);
          }
        }
        commentForm
        .reset()
      }
    )
  }
</script>
<script>
  // 댓글 수정 비동기
  const ok_function = (e) => {
    const commentId = event.target.dataset.commentupId
    const reviewId = event.target.dataset.reviewupId
    const inputCommentPk = document.querySelector(`#input-${commentId}`)

    axios({
      method: 'post',
      url: `/articles/${event.target.dataset.articlesupId}/comment_update/${event.target.dataset.commentupId}/update/`,
      headers: {
        'X-CSRFToken': csrftoken
      },
      data: {
        'content': inputCommentPk.value
      }
    }).then(response => {
      console.log(response)
      const comments = document.querySelector('#comments')
      comments.textContent = "";
      const hr = document.createElement('hr')
      const comment_data = response.data.comment_data
      const user = response.data.user
        for (let i = 0; i < comment_data.length; i++) {
          const articles_pk = response.data.articles_pk
            console.log(comment_data[i].id, user, comment_data[i].unname)
          if (user === comment_data[i].id) {
            comments.insertAdjacentHTML('beforeend', `
            <div class="comment">
              <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
              <div>
                <div>
                  <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
                    <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
                    <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-articlesup-id="${ articles_pk }" data-commentup-id="${comment_data[i].commentPk}">확인</button>
                  </div>
                  <button  onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-articlesup-id="${ articles_pk }" data-commentup-id="${comment_data[i].commentPk}">수정</button>\
                  <button  onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-articlesdel-id="${ articles_pk }" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                </div>
              </div>
            </div>
            `);
          } else {
            comments.insertAdjacentHTML('beforeend', `
              <div class="comment">
                <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
              </div>
            `);
          }
        }
        commentForm
        .reset()
      }
    )
  }
  const update_comment = (e) => {
    const comment_id = document.querySelector(`#${e.id}`).id
    const input = document.createElement('input')
    const comment = document.querySelector('#comment')
    const span = document.createElement('span')
    const comment_update_form = document.querySelector(`#form-${e.id}`)
    const comment_update = document.querySelector(`#${e.id}`)
    comment_update_form.style.display = ""
    comment_update.style.display = "none"
  }
</script>

{% endblock js %}