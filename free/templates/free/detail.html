{% extends 'base.html' %}
{% load django_bootstrap5%}
{% load static %}

{% block content %}

  익명{{free.user.pk}}</a>
{{free.title}}
{{free.updated_at}}
{{free.content}}

{% if photos %}
  {% for photo in photos %}
    <img src="{{ photo.image.url }}">
  {% endfor %}
{% endif %}

<!-- 수정 / 삭제 -->
{% if request.user == free.user %}
  <div class="d-flex justify-content-end">
    <a href="{% url 'free:update' free.pk %}" class="btn btn-primary">수정</a>
    <form class="m-0" action="{% url 'free:delete' free.pk %}" method="POST">
      {% csrf_token %}
      <input type="submit" value="삭제">
    </form>
  </div>
{% endif %}

{% if request.user.is_authenticated %}
  <div class="heart">
    {% if request.user not in free.like_free.all %}
      <i data-like-id="{{ free.pk }}" id="like-btn" class="bi bi-heart free-heart"></i>
    {% else %}
      <i data-like-id="{{ free.pk }}" id="like-btn" class="bi bi-heart-fill free-heart-fill"></i>
    {% endif %}
    <p id="likes">{{ free.like_free.count }}</p>
  </div>
{% endif %}

<!-- 댓글 -->
<section class="comment-box">
  {% if request.user.is_authenticated %}
    <form id="comment-form" data-free-id="{{ free.pk }}" action="{% url 'free:comment_create' free.pk %}" method="POST">
      {% csrf_token %}
      {% bootstrap_form comment_form %}
      <input class="btn btn-success" type="submit" value="제출">
    </form>
  {% endif %}
  <div id="comments" class="comments">
    {% for comment in comments %}
      <div class="comment">
        <h4>익명{{comment.user.pk}}
          -
          {{ comment.content }}</h4>
        <div class="comment-user-info justify-content-between">
          {% if request.user.pk == comment.user.pk %}
            <div>
              <div id="form-comment-update-{{ comment.pk }}" style="display:none;">
                <input id="input-{{ comment.pk }}" type="text" value="{{ comment.content }}">
                <button onclick="ok_function(this)" id="okBtn-{{ comment.pk }}" data-freeup-id="{{ free.pk }}" data-commentup-id="{{ comment.pk }}">확인</button>
              </div>
              <button onclick="update_comment(this)" id="comment-update-{{ comment.pk }}" data-freeup-id="{{ free.pk }}" data-commentup-id="{{ comment.pk }}">수정</button>
              <button onclick="delete_comment(this)" id="comment-delete-{{ comment.pk }}" data-freedel-id="{{ free.pk }}" data-commentdel-id="{{ comment.pk }}">삭제</button>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endblock %}


{% block js %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  //좋아요
  const likeBtn = document.querySelector('#like-btn')
  likeBtn.addEventListener('click', function (event) {
  console.log(event.target.dataset)
  axios({
    method: 'get',
    url: `/free/${event.target.dataset.likeId}/like/`
  })
  .then(response => {
    console.log(response.data)
    if (response.data.isLike === true) {
      event.target.classList.add('bi-heart-fill')
      event.target.classList.add('free-heart-fill')
      event.target.classList.remove('bi-heart')
      event.target.classList.remove('free-heart')
      // console.log('좋아요')
    } else {
      event.target.classList.add('bi-heart')
      event.target.classList.add('free-heart')
      event.target.classList.remove('bi-heart-fill')
      event.target.classList.remove('free-heart-fill')
      // console.log('좋아요아님')
    }
    const likeCount = document.querySelector('#likes')
    likeCount.innerHTML = `<h6 class="likes m-0"> ${response.data.likeCount}</h6>`
  })
})
</script>
<script>
  //댓글 생성 비동기
  const commentForm = document.querySelector('#comment-form')
  const csrftoken = document
    .querySelector('[name=csrfmiddlewaretoken]')
    .value

    commentForm
    .addEventListener('submit', function (event) {
      event.preventDefault();
      axios({
        method: 'post',
        url: `/free/${event.target.dataset.freeId}/comments_create/`,
        headers: {
          'X-CSRFToken': csrftoken
        },
        data: new FormData(commentForm)
      })
        .then(response => {
          console.log(response)
          const comments = document.querySelector('#comments')
          comments.textContent = "";
          const hr = document.createElement('hr')
          const comment_data = response.data.comment_data
          const user = response
            .data
            .user
            for (let i = 0; i < comment_data.length; i++) {
              const free_pk = response
                .data
                .free_pk
                console
                .log(comment_data[i].id, user, comment_data[i].unname)
              if (user === comment_data[i].id) {
                comments.insertAdjacentHTML('beforeend', `
                  <div class="comment">
                    <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
                    <div>
                      <div>
                        <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
                          <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
                          <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-freeup-id="${free_pk}" data-commentup-id="${comment_data[i].commentPk}">확인</button>
                        </div>
                        <button  onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-freeup-id="${free_pk}" data-commentup-id="${comment_data[i].commentPk}">수정</button>\
                        <button  onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-freedel-id="${free_pk}" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                      </div>
                    </div>
                  </div>
                  `);
              } else {
                comments.insertAdjacentHTML('beforeend', `
                    <div class="comment">
                      <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
                    </div>
                  `);
              }
            }
            commentForm
            .reset()
        })
        .catch(console.log(1))
      })
</script>
<script>
  // 댓글 삭제 비동기
  const delete_comment = (e) => {
    const comment_id = document
      .querySelector(`#${e.id}`)
      .id;
    axios({
      method: 'post',
      url: `/free/${event.target.dataset.freedelId}/comment_delete/${event.target.dataset.commentdelId}/delete/`,
      headers: {
        'X-CSRFToken': csrftoken
      }
    }).then(response => {
      console.log(response)
      const comments = document.querySelector('#comments')
      comments.textContent = "";
      const hr = document.createElement('hr')
      const comment_data = response.data.comment_data
      const user = response
        .data
        .user
        for (let i = 0; i < comment_data.length; i++) {
          const free_pk = response
            .data
            .free_pk
            console
            .log(comment_data[i].id, user, comment_data[i].unname)
          if (user === comment_data[i].id) {
            comments.insertAdjacentHTML('beforeend', `
            <div class="comment">
              <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
              <div>
                <div>
                  <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
                    <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
                    <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-freeup-id="${free_pk}" data-commentup-id="${comment_data[i].commentPk}">확인</button>
                  </div>
                  <button  onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-freeup-id="${free_pk}" data-commentup-id="${comment_data[i].commentPk}">수정</button>\
                  <button  onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-freedel-id="${free_pk}" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                </div>
              </div>
            </div>
            `);
          } else {
            comments.insertAdjacentHTML('beforeend', `
              <div class="comment">
                <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
              </div>
            `);
          }
        }
        commentForm
        .reset()
    })
  }
</script>
<script>
  // 댓글 수정 비동기
  const ok_function = (e) => {
    const commentId = event.target.dataset.commentupId
    const freeId = event.target.dataset.freeupId
    const inputCommentPk = document.querySelector(`#input-${commentId}`)

    axios({
      method: 'post',
      url: `/free/${event.target.dataset.freeupId}/comment_update/${event.target.dataset.commentupId}/update/`,
      headers: {
        'X-CSRFToken': csrftoken
      },
      data: {
        'content': inputCommentPk.value
      }
    }).then(response => {
      console.log(response)
      const comments = document.querySelector('#comments')
      comments.textContent = "";
      const hr = document.createElement('hr')
      const comment_data = response.data.comment_data
      const user = response
        .data
        .user
        for (let i = 0; i < comment_data.length; i++) {
          const free_pk = response
            .data
            .free_pk
            console
            .log(comment_data[i].id, user, comment_data[i].unname)
          if (user === comment_data[i].id) {
            comments.insertAdjacentHTML('beforeend', `
            <div class="comment">
              <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
              <div>
                <div>
                  <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
                    <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
                    <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-freeup-id="${free_pk}" data-commentup-id="${comment_data[i].commentPk}">확인</button>
                  </div>
                  <button  onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-freeup-id="${free_pk}" data-commentup-id="${comment_data[i].commentPk}">수정</button>\
                  <button  onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-freedel-id="${free_pk}" data-commentdel-id="${comment_data[i].commentPk}">삭제</button>
                </div>
              </div>
            </div>
            `);
          } else {
            comments.insertAdjacentHTML('beforeend', `
              <div class="comment">
                <h4>${comment_data[i].userName} - ${comment_data[i].content}</h4>
              </div>
            `);
          }
        }
        commentForm
        .reset()
    })
  }
  const update_comment = (e) => {
    const comment_id = document
      .querySelector(`#${e.id}`)
      .id
    const input = document.createElement('input')
    const comment = document.querySelector('#comment')
    const span = document.createElement('span')
    const comment_update_form = document.querySelector(`#form-${e.id}`)
    const comment_update = document.querySelector(`#${e.id}`)
    comment_update_form.style.display = ""
    comment_update.style.display = "none"
  }
</script>

{% endblock js %}